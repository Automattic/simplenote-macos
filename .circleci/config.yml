version: 2.1

orbs:
  # This uses the Orbs located at https://github.com/wordpress-mobile/circleci-orbs
  ios: wordpress-mobile/ios@1.0

# Reusable sets of steps
commands:
  setup_environment:
    steps:
      - checkout
      - run:
          name: Copy Demo SPCredentials
          command: |
            mkdir -p Simplenote/Credentials
            cp Simplenote/SPCredentials-demo.swift Simplenote/Credentials/SPCredentials.swift
      - ios/install-dependencies:
          bundle-install: true
          pod-install: true
      - run:
          # See https://support.circleci.com/hc/en-us/articles/360044709573-Swift-Package-Manager-fails-to-clone-from-private-Git-repositories
          name: Workaround for Swift Package Manager and xcodebuild
          command: |
            rm ~/.ssh/id_rsa
            for ip in $(dig @8.8.8.8 github.com +short); do ssh-keyscan github.com,$ip; ssh-keyscan $ip; done 2>/dev/null >> ~/.ssh/known_hosts || true

jobs:
  Test:
    executor:
      name: ios/default
      xcode-version: "12.0"
    steps:
      - setup_environment
      - run:
          name: Build & Test
          # We've seen some builds timeout because CircleCI didn't receive
          # output for 10m. Making it wait for 20m instead should address that.
          #
          # For example,
          # https://app.circleci.com/pipelines/github/Automattic/simplenote-macos/1879/workflows/23bba8c2-3bc0-447e-877c-b3eadd326c12/jobs/1834
          # timed out but its re-run
          # https://app.circleci.com/pipelines/github/Automattic/simplenote-macos/1879/workflows/d1d5b6d6-90b0-42c4-81ff-466625e26a6b/jobs/1835
          # succeeded
          no_output_timeout: 20m
          command: |
            # Build without code signing to avoid missing cert errors
            xcodebuild clean test \
                -workspace 'Simplenote.xcworkspace' \
                -scheme 'Simplenote' \
                -configuration 'Debug' \
                COMPILER_INDEX_STORE_ENABLE=NO \
                CODE_SIGN_IDENTITY="" \
                CODE_SIGNING_REQUIRED=NO

  Build App Store Target:
    executor:
      name: ios/default
      xcode-version: "12.0"
    steps:
      - setup_environment
      - run:
          name: Build App Store Target
          command: |
            # Build without code signing to avoid missing cert errors
            xcodebuild clean build \
                -workspace 'Simplenote.xcworkspace' \
                -scheme 'Simplenote-AppStore' \
                -configuration 'Release' \
                COMPILER_INDEX_STORE_ENABLE=NO \
                CODE_SIGN_IDENTITY="" \
                CODE_SIGNING_REQUIRED=NO

  App Store Deployment:
    executor:
      name: ios/default
      xcode-version: "12.0"
    steps:
      - setup_environment
      - run:
          name: Build & Test
          command: |
            bundle exec fastlane build_and_upload_app_store create_github_release:true

workflows:
  simplenote_macos:
    jobs:
      - Test
      - Build App Store Target

  deploy_to_app_store:
    jobs:
      - Test:
          # Only run on tags in the 1.2 or 1.2.3 form – i.e. only final release
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+(\.\d)?$/
      - App Store Deployment:
          requires: [ Test ]
          # Only run on tags in the 1.2 or 1.2.3 form – i.e. only final release
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+(\.\d)?$/
